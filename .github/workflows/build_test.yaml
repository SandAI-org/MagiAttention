name: MagiAttention Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    outputs:
      magi_attention: ${{ steps.filter.outputs.magi_attention }}
      changes: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Fail if PR title is [WIP] or [DO NOT MERGE]
        if: github.event_name == 'pull_request'
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ "$PR_TITLE" == "[WIP]"* ]] || [[ "$PR_TITLE" == "[DO NOT MERGE]"* ]]; then
            echo "::error::Pull Request title starts with [WIP] or [DO NOT MERGE]."
            exit 1
          else
            echo "PR title is clean: $PR_TITLE"
          fi

      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api:
              - 'magi_attention/api/**'
            utils:
              - 'magi_attention/utils/**'
            comm:
              - 'magi_attention/comm/**'
              - 'magi_attention/csrc/comm/**'
            common:
              - 'magi_attention/common/**'
            ffa:
              - 'magi_attention/functional/flexible_flash_attn.py'
              - 'magi_attention/functional/_flex_flash_attn_jit.py'
              - 'magi_attention/csrc/common/**'
              - 'magi_attention/csrc/extensions/**'
              - 'magi_attention/csrc/flexible_flash_attention/**'
              - 'magi_attention/csrc/utils/**'
            dffa:
              - 'magi_attention/functional/**'
              - '!magi_attention/functional/flexible_flash_attn.py'
              - '!magi_attention/functional/_flex_flash_attn_jit.py'
              - 'magi_attention/meta/**'
            magi_attention:
              - 'magi_attention/**'

      - name: print filter results
        run: |
          echo "Changes detected: ${{ steps.filter.outputs.changes }}"
          echo "Is MagiAttention modified: ${{ steps.filter.outputs.magi_attention }}"

  test_MagiAttention:
    needs: [detect_changes]
    if: |
      always() &&
      needs.detect_changes.outputs.magi_attention == 'true'
    runs-on: [self-hosted]
    container:
      image: registry.cn-sh-01.sensecore.cn/sandai-ccr/magi-base:25.05.4
      options: --gpus all --ipc host
      credentials:
        username: ${{ secrets.DOCKER_USER_NAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      env:
        http_proxy: ${{ secrets.HTTP_PROXY }}
        https_proxy: ${{ secrets.HTTP_PROXY }}
        GITHUB_SHA: ${{ github.sha }}
      volumes:
        - /mnt/afs/littsk/ci_workspace_magi_attention/:/workspace
    steps:
      - name: echo proxy
        run: |
          echo "http_proxy: $http_proxy"
          echo "https_proxy: $https_proxy"

      - name: curl google
        run: |
          curl www.google.com

      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: install requirements
        run: |
          bash -x .github/scripts/install_requirements.sh

      - name: install MagiAttention
        run: |
          pip install -e . --no-build-isolation -vvv

      - name: Determine Test Targets and Run
        id: run_tests
        env:
          CHANGES: ${{ needs.detect_changes.outputs.changes }}
          EVENT_NAME: ${{ github.event_name }}
          COVERAGE_RUN: True
        run: |
          TEST_TARGETS=""

          echo "Event Name: $EVENT_NAME"
          echo "Detected Changes: $CHANGES"


          if [[ "$EVENT_NAME" == "push" ]]; then
            echo "Push event detected (Merge). Running ALL tests."
            TEST_TARGETS="./tests"

          else
            echo "Pull Request detected. Selecting tests based on filters..."

            # (1) api -> tests/test_api
            if [[ "$CHANGES" == *"api"* ]]; then
              TEST_TARGETS="$TEST_TARGETS ./tests/test_api"
            fi

            # (2) utils -> tests/test_utils
            if [[ "$CHANGES" == *"utils"* ]]; then
              TEST_TARGETS="$TEST_TARGETS ./tests/test_utils"
            fi

            # (3) comm -> tests/test_comm
            if [[ "$CHANGES" == *"comm"* ]]; then
              TEST_TARGETS="$TEST_TARGETS ./tests/test_comm"
            fi

            # (4) common -> tests/test_common
            if [[ "$CHANGES" == *"common"* ]]; then
              TEST_TARGETS="$TEST_TARGETS ./tests/test_common"
            fi

            # (5) ffa -> tests/test_attn
            if [[ "$CHANGES" == *"ffa"* ]]; then
              TEST_TARGETS="$TEST_TARGETS ./tests/test_attn"
            fi

            # (6) dffa -> pipeline tests + solver + dispatch + dist_runtime
            if [[ "$CHANGES" == *"dffa"* ]]; then
              TEST_TARGETS="$TEST_TARGETS ./tests/test_pipeline_sdpa.py ./tests/test_pipeline.py ./tests/test_attn_solver ./tests/test_dispatch ./tests/test_dist_runtime_mgr"
            fi
          fi

          TEST_TARGETS=$(echo $TEST_TARGETS | xargs)

          if [[ -z "$TEST_TARGETS" ]]; then
             echo "::warning::No specific test filters matched and not a merge event. Skipping tests."
             exit 0
          fi

          echo "========================================"
          echo "Running pytest on: $TEST_TARGETS"
          echo "========================================"

          coverage run --source magi_attention -m pytest -qsv $TEST_TARGETS

          coverage combine
          coverage xml -i

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        if: success() && hashFiles('coverage.xml') != ''
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SandAI-org/MagiAttention
          files: coverage.xml
